{% extends 'receipt/receipt_base.html'%}
{% load static %}

{% block title_block %}
    Create receipt
{% endblock %}

{% block body_block %}

    <link rel="stylesheet" href="{% static 'css/receipt/create_receipt.css' %}" type="text/css">
    <div class="container my-5" style="text-align: center;">
        
        <form onsubmit="event.preventDefault();">
            <div class="form-inline my-5" style="text-align: center;">
                
                <input type="text" id="product-name" name="product-name" class="form-control m-2" placeholder="Product name">
                <input type="text" id="product-quantity" name="product-quantity" class="form-control m-2" placeholder="Product quantity">
                <input type="text" id="product-tax" name="product-tax" class="form-control m-2" placeholder="Product tax">
                <input type="text" id="product-price" name="product-price" class="form-control m-2" placeholder="Product price">                                
                <button id="add-product" type="submit">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                    Add
                </button>
            </div>
        </form>

        <h1 style="text-align: center;" class="my-5">Product list</h1>
        <div id="product-list" class="my-5">


        </div>

        <div style="text-align: center;">
            <p class="lead">
                Subtotal: &#x20B9 <span id="subtotal">0.00</span>
            </p>
            <p class="lead">
                Total tax: &#x20B9 <span id="total-tax">0.00</span>
            </p>
            <p class="lead">
                Total Price: &#x20B9 <span id="total-price">0.00</span>
            </p>
        </div>

        
        <form id="form-create-receipt" method="POST" action="{% url 'receipt:create_receipt' %}" onsubmit="event.preventDefault();">
            {% csrf_token %}
            <div class="form-group" style="text-align: center;">
                <input id="create-receipt" type="submit" value="SUBMIT" onclick="event.preventDefault();" class="btn btn-lg btn-success m-5" style="text-align: center;">
            </div>
        </form>
    
    </div>


    <script>
        function calculate()
        {
            console.log("Calculate function");
           
            product_list = $("#product-list").children('div');
            product_list_quantity = product_list.children("input[name='list-product-quantity']");
            product_list_tax = product_list.children("input[name='list-product-tax']");
            product_list_price = product_list.children("input[name='list-product-price']");

            console.log(product_list_quantity);
            
            var total_tax = 0;
            var subtotal = 0;
            var total_price = 0;

            var i;
            for(i=0;i<product_list_price.length;i++)
            {
                price = parseFloat(product_list_price[i].value);
                tax = parseFloat(product_list_tax[i].value);
                quantity = parseInt(product_list_quantity[i].value);

                console.log(quantity,tax,price);

                total_tax+=quantity*tax;
                subtotal+=quantity*price;
            }
            total_price=total_tax+subtotal;

            $("#subtotal").text(""+subtotal);
            $("#total-tax").text(""+total_tax);
            $("#total-price").text(""+total_price);
        }
        $(document).ready(function () {
            var checkCount = 1;
            console.log(checkCount)
            $("#add-product").click(function (e) {
                var product_name = $('#product-name').val();
                var product_quantity=$("#product-quantity").val();
                var product_tax=$("#product-tax").val();
                var product_price=$("#product-price").val();
                
                checkCount++;
                if(product_name!="" && product_price!="" && product_quantity!="" && product_tax!="")
                {

                     $("#product-list").append(
                        '<div class="form-inline my-5">\
                            <input type="text" id="list-product-name-' + checkCount + '" name="list-product-name" class="form-control m-2" placeholder="Product Name" value="'+product_name+'" onchange="calculate();"/>\
                            <input name="list-product-quantity" id="list-product-quantity-"'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_quantity+'"  placeholder="Product quantity" onchange="calculate();">\
                            <input name="list-product-tax" id="list-product-tax-"'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_tax+'"  placeholder="Product Tax" onchange="calculate();">\
                            <input name="list-product-price" id="list-product-price-"'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_price+'"  placeholder="Product Price" onchange="calculate();">\
                            <a href="#" id="list-product-remove" class="form-control m-2 bg-danger text-white">\
                                <i class="fa fa-trash-alt">X</i>\
                            </a>\
                        </div>'
                    );
                    $("#product-name").val("");
                    $("#product-quantity").val("");
                    $("#product-tax").val("");
                    $("#product-price").val("");

                    calculate();
                }
            });
    
            $("#product-list").on("click", "#list-product-remove", function (e) { 
                e.preventDefault();              
                $(this).parent('div').remove();
                checkCount--;
                calculate();
            });
    
            $("#create-receipt").click(function (e) {
                var resultArray = [];
                $('#product-list').find('div.form-inline').each(function() {
                    var rowData = {};
                    
                    rowData['product'] = $(this).find('[name="list-product-name"]').val();
                    rowData['product_quantity'] = $(this).find('[name="list-product-quantity"]').val();
                    rowData['product_tax'] = $(this).find('[name="list-product-tax"]').val();
                    rowData['product_price'] = $(this).find('[name="list-product-price"]').val();
                    rowData['product_ID'] = $(this).find('input[type=text]').attr('id');
                    resultArray.push(rowData);
                });
                console.log(resultArray);

                $.post("{%  url 'receipt:create_receipt' %}" , 
                    { 
                    arr: JSON.stringify(resultArray), // <-----------
                    csrfmiddlewaretoken :  '{{ csrf_token }}' 
                    }, 
                    function(data) {
                        if(data.status == 1){ // meaning that everyhting went ok
                           // do something
                           //window.location='{% url "mainApp:index" %}';
                        }
                        else{
                           alert(data.message)
                           // do your redirect
                           
                        }   
                    });


            });
        });
    </script>

{% endblock %}

