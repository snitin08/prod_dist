{% extends 'receipt/receipt_base.html'%}
{% load static %}

{% block title_block %}
    Create receipt
{% endblock %}

{% block body_block %}

    <link rel="stylesheet" href="{% static 'css/receipt/create_receipt.css' %}" type="text/css">
    <div class="container my-5" style="text-align: center;">
        
        <form onsubmit="event.preventDefault();">
            <div class="form-inline my-5" style="text-align: center;">
                
                <input type="text" id="product-name" name="product-name" class="form-control m-1" placeholder="Product name" list="productList" onchange="fillProductDetails();">
                <input type="text" id="product-quantity" name="product-quantity" class="form-control m-1" placeholder="Product quantity">
                <input type="text" id="product-tax" name="product-tax" class="form-control m-1" placeholder="Product tax">
                <input type="text" id="product-price" name="product-price" class="form-control m-1" placeholder="Product price">
                <input type="text" id="product-discount" name="product-discount" class="form-control m-1" placeholder="Product discount">                                
                <button id="add-product" type="submit">
                    <i class="fa fa-plus" aria-hidden="true"></i>
                    Add
                </button>
            </div>
        </form>


        {% if request.session.type == "Company" %}
            <datalist id="productList" onchange="fillProductDetails();">
                {% for product in products %}
                    <option price="{{product.product_distributor_price}}" value="{{product.product_name}}" tax="{{product.product_tax}}" discount="{{product.product_discount}}"/>           
                {% endfor %}
            </datalist>
        {% elif request.session.type == "distributor" %}
            <datalist id="productList" onchange="fillProductDetails();">
                {% for product in products %}
                    <option price="{{product.product_mrp}}" value="{{product.product_name}}" tax="{{product.product_tax}}" discount="{{product.product_discount}}"/>           
                {% endfor %}
            </datalist>
        {% endif %}
        <h1 style="text-align: center;" class="my-5">Product list</h1>
        <div id="product-list" class="my-5">


        </div>

        <div style="text-align: center;">
            <p class="lead">
                Subtotal: &#x20B9 <span id="subtotal">0.00</span>
            </p>
            <p class="lead">
                Total tax: &#x20B9 <span id="total-tax">0.00</span>
            </p>
            <p class="lead">
                Total Price: &#x20B9 <span id="total-price">0.00</span>
            </p>
            <p class="lead">
                Total Discount: &#x20B9 <span id="total-discount">0.00</span>
            </p>
        </div>

        
        <form id="form-create-receipt" method="POST" action="{% url 'receipt:create_receipt' %}" onsubmit="event.preventDefault();">
            {% csrf_token %}

            {% if request.session.type == "Company" %}
                <div class="form-group">
                    <label for="user_to">Select a distributor</label>
                    <select name="user_to" id="user_to">
                        <option value=1>Distributor 1</option>
                        <option value=2>Distributor 2</option>
                    </select>
                </div>
            {% else %}
                <div class="form-group">
                    <label for="user_to">Select a retailer</label>
                    <select name="user_to" id="user_to">
                        <option value=1>Retailer 1</option>
                        <option value=2>Retailer 2</option>
                    </select>
                </div>
            {% endif %}

            <div class="form-group" style="text-align: center;">
                <input id="create-receipt" type="submit" value="SUBMIT" onclick="event.preventDefault();" class="btn btn-lg btn-success m-5" style="text-align: center;">
            </div>
        </form>
    
    </div>


    <script>

        function fillProductDetails()
        {
            const Value = document.getElementById('product-name').value;            
            const selectedOption = document.querySelector('option[value="' + Value + '"]');
            
            var price = selectedOption.getAttribute("price");
            var tax = selectedOption.getAttribute("tax");
            var discount = selectedOption.getAttribute("discount");

            var priceField = document.getElementById("product-price");
            var taxField = document.getElementById("product-tax");
            var discountField = document.getElementById("product-discount");

            priceField.value = price;
            taxField.value = tax;
            discountField.value = discount;
        }

        function productListFill(id)
        {
            const Value = document.getElementById('list-product-name-'+id).value;            
            const selectedOption = document.querySelector('option[value="' + Value + '"]');
            console.log(id,Value);
            
            var price = selectedOption.getAttribute("price");
            var tax = selectedOption.getAttribute("tax");
            var discount = selectedOption.getAttribute("discount");

            var priceField = document.getElementById("list-product-price-"+id);
            var taxField = document.getElementById("list-product-tax-"+id);
            var discountField = document.getElementById("list-product-discount-"+id);
            
            priceField.value = price;
            taxField.value = tax;
            discountField.value = discount;
        }

        function calculate()
        {
            console.log("Calculate function");
           
            product_list = $("#product-list").children('div');
            product_list_quantity = product_list.children("input[name='list-product-quantity']");
            product_list_tax = product_list.children("input[name='list-product-tax']");
            product_list_price = product_list.children("input[name='list-product-price']");
            product_list_discount = product_list.children("input[name='list-product-discount']");

            console.log(product_list_quantity);
            
            var total_tax = 0;
            var subtotal = 0;
            var total_price = 0;
            var total_discount = 0;

            var i;
            for(i=0;i<product_list_price.length;i++)
            {
                price = parseFloat(product_list_price[i].value);
                tax = parseFloat(product_list_tax[i].value);
                quantity = parseFloat(product_list_quantity[i].value);
                discount = parseFloat(product_list_discount[i].value);

                console.log(quantity,tax,price);

                total_tax+=quantity*tax;
                subtotal+=quantity*price;
                total_discount+=discount*quantity;
            }
            total_price=total_tax+subtotal-total_discount;

            $("#subtotal").text(""+subtotal);
            $("#total-tax").text(""+total_tax);
            $("#total-price").text(""+total_price);
            $("#total-discount").text(""+total_discount);
        }
        $(document).ready(function () {
            var checkCount = 1;
            console.log(checkCount);


            

            $("#add-product").click(function (e) {
                var product_name = $('#product-name').val();
                var product_quantity=$("#product-quantity").val();
                var product_tax=$("#product-tax").val();
                var product_price=$("#product-price").val();
                var product_discount=$("#product-discount").val();
                
                checkCount++;
                if(product_name!="" && product_price!="" && product_quantity!="" && product_tax!="")
                {

                     $("#product-list").append(
                        '<div class="form-inline my-5">\
                            <input type="text" id="list-product-name-' + checkCount + '" name="list-product-name" class="form-control m-2" placeholder="Product Name" value="'+product_name+'" onchange="productListFill('+checkCount+'); calculate();" list="productList" onChange="productListFill('+checkCount+');"/>\
                            <input name="list-product-quantity" id="list-product-quantity-'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_quantity+'"  placeholder="Product quantity" onchange="calculate();">\
                            <input name="list-product-tax" id="list-product-tax-'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_tax+'"  placeholder="Product Tax" onchange="calculate();">\
                            <input name="list-product-price" id="list-product-price-'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_price+'"  placeholder="Product Price" onchange="calculate();">\
                            <input name="list-product-discount" id="list-product-discount-'+ checkCount+ '" class="form-control m-2" type="text" value="'+product_discount+'"  placeholder="Product discount" onchange="calculate();">\
                            <a href="#" id="list-product-remove" class="form-control m-2 bg-danger text-white">\
                                <i class="fa fa-trash-alt">X</i>\
                            </a>\
                        </div>'
                    );
                    $("#product-name").val("");
                    $("#product-quantity").val("");
                    $("#product-tax").val("");
                    $("#product-price").val("");
                    $("#product-discount").val("");

                    calculate();
                }
            });
    
            $("#product-list").on("click", "#list-product-remove", function (e) { 
                e.preventDefault();              
                $(this).parent('div').remove();
                checkCount--;
                calculate();
            });
    
            $("#create-receipt").click(function (e) {
                var resultArray = [];
                $('#product-list').find('div.form-inline').each(function() {
                    var rowData = {};
                    
                    rowData['product'] = $(this).find('[name="list-product-name"]').val();
                    rowData['product_quantity'] = $(this).find('[name="list-product-quantity"]').val();
                    rowData['product_tax'] = $(this).find('[name="list-product-tax"]').val();
                    rowData['product_price'] = $(this).find('[name="list-product-price"]').val();
                    rowData['product_discount'] = $(this).find('[name="list-product-discount"]').val();
                    rowData['product_ID'] = $(this).find('input[type=text]').attr('id');
                    resultArray.push(rowData);
                });
                console.log(resultArray);

                $.post("{%  url 'receipt:create_receipt' %}" , 
                    { 
                    arr: JSON.stringify(resultArray), // <-----------
                    csrfmiddlewaretoken :  '{{ csrf_token }}' 
                    }, 
                    function(data) {
                        if(data.status == 1){ // meaning that everyhting went ok
                           // do something
                           //window.location='{% url "mainApp:index" %}';
                        }
                        else{
                           alert(data.message)
                           // do your redirect
                           
                        }   
                    });


            });
        });
    </script>

{% endblock %}

